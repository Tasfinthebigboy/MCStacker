//Copyright 2022 Matt Godfrey, (https://mcstacker.net/npc/) Please don't steal my code or an evil NPC will haunt you in your dreams.  
var numberPattern=/\d+/g,commandSet=0,functionSets={},mouse={x:0,y:0};function zipIt(){var e=new JSZip,a=(e.file("pack.mcmeta",make_pack_mcmeta()),e.folder("data/"+$("#nameSpace").val().trim()+"/functions/"));for(fKey in a.file("main_"+$("#baseTag").val().toLowerCase()+".mcfunction",$("#mainCommands").val()),a.file("cleanup_"+$("#baseTag").val().toLowerCase()+".mcfunction",$("#cleanupCommands").val()),a.file("setup_"+$("#baseTag").val().toLowerCase()+".mcfunction",$("#setupCommands").val()),functionSets)a.file("cmdgroup"+fKey+"_"+$("#baseTag").val().toLowerCase()+".mcfunction",$("#cmdgroup"+fKey).val());$("#mainTick").is(":checked")&&e.file("data/minecraft/tags/functions/tick.json",make_tick_json()),e.generateAsync({type:"blob"}).then(function(e){saveAs(e,$("#datapackName").val().trim()+".zip")})}function make_tick_json(){return`{
		"values":["${$("#nameSpace").val().trim()}:${"main_"+$("#baseTag").val().toLowerCase()}"]
	}`}function make_pack_mcmeta(){return`{
	"pack": {
	   "pack_format":18,
	   "description":"${$("#description").val().trim()}"
	}
 }`}function exportAsJSON(){var i={baseTag:$("#baseTag").val(),nameSpace:$("#nameSpace").val(),datapackName:$("#datapackName").val(),mainTick:$("#mainTick").is(":checked"),distanceReset:$("#distanceReset").is(":checked"),targetDistance:$("#targetDistance").val(),description:$("#description").val(),textColor:$("#textColor").val(),optionColor:$("#optionColor").val(),npcSays:[]},e=($(".npcSays").each(function(){var o=this.id.match(numberPattern)[0];i.npcSays.push({id:o,says:$("#npcSays"+o).val(),options:[]}),$("#npcSaysDiv"+o+" .option").each(function(){var a=o+"_"+this.id.match(numberPattern)[1],e=$("#optionText"+a).val(),t=$("#commandSet"+a).val(),n=$("#executeAt"+a).val().trim(),e={oid:a,optionText:e,cmdSet:t,gotoSection:$("#gotoSection"+a).val(),executeAt:n,commands:[]};$("#hoverText"+a).val().length&&(e.hoverText=$("#hoverText"+a).val()),i.npcSays[i.npcSays.length-1].options.push(e),$("#commands"+a+" .command").each(function(){var e=a+"_"+this.id.match(numberPattern)[2];$("#command"+e).val().trim();i.npcSays[i.npcSays.length-1].options[i.npcSays[i.npcSays.length-1].options.length-1].commands.push({cid:e,command:$("#command"+e).val().trim()})})})}),new Blob([JSON.stringify(i)],{type:"text/plain;charset=utf-8"}));saveAs(e,$("#datapackName").val().trim()+"_json.txt")}function readURL(e){var a;e.files&&e.files[0]&&((a=new FileReader).onload=function(e){importAsJSON(e.target.result),$("#jsonIn").hide()},a.readAsText(e.files[0]))}function importAsJSON(e){var a=JSON.parse(e);$("#baseTag").val(a.baseTag),$("#nameSpace").val(a.nameSpace),$("#datapackName").val(a.datapackName),$("#mainTick").prop("checked",a.mainTick),$("#distanceReset").prop("checked",a.distanceReset),$("#targetDistance").val(a.targetDistance),$("#description").val(a.description),$("#textColor").val(a.textColor),$("#optionColor").val(a.optionColor),$(".npcSays").remove();for(var t=0;t<a.npcSays.length;t++)addNPCSays(n=a.npcSays[t].id),$("#npcSays"+n).val(a.npcSays[t].says);for(t=0;t<a.npcSays.length;t++)for(var n=a.npcSays[t].id,o=0;o<a.npcSays[t].options.length;o++){var i=a.npcSays[t].options[o];addOption(n,parseInt(i.oid.match(numberPattern)[1]),i.cmdSet),$("#executeAt"+i.oid).val(i.executeAt),null!=i.optionText&&$("#optionText"+i.oid).val(i.optionText),null!=i.hoverText&&$("#hoverText"+i.oid).val(i.hoverText),$("#gotoSection"+i.oid).val(i.gotoSection);for(var s=0;s<i.commands.length;s++){var c=i.commands[s].cid;addCommand(i.oid,i.cmdSet,parseInt(c.match(numberPattern)[2])),$("#command"+c).val(i.commands[s].command)}}generate()}function addNPCSays(e){for(var a=null==e?1:e;$("#npcSaysDiv"+a).length;)a++;var t,e="Statement "+a;return 1==a?(t="",e+=" (The first thing it says)"):t="<button id='deleteStatement"+a+"' class='addOption redx'>X</button>",$(`<div id='npcSaysDiv${a}' class='npcSays roundedDiv'><span class='sectionHeading'>${e}</span> ${t}<br>
	<span class='label'>NPC Says</span><input type='text' id='npcSays${a}' class='longField'>${makeTip("statement")}<br>
	<div id='npcOptionsDiv${a}' class='options'>
	<button id='addOption${a}' class='addOption'>Add Option</button><br>
	</div></div>`).insertBefore("#bDivide"),$("input").bind("keyup",function(){generate()}),$("#addOption"+a).bind("click",function(e){addOption(e.target.id.match(numberPattern))}),0!=a&&$("#deleteStatement"+a).bind("click",function(e){$("#npcSaysDiv"+a).remove(),updateAllSectionOptions(),generate()}),updateAllSectionOptions(),generate(),a}function addOption(e,a,t){var n;if(null==t?commandSet++:commandSet=t,null==a)for(n=0;$("#option"+e+"_"+n).length;)n++;else n=a;t=e+"_"+n;$("#npcOptionsDiv"+e).append(`<div id='option${t}' class='roundedDiv option'><span class='sectionHeading'>Option ${n+1}</span> <button id='delOption${t}' class='redx'>X</button><br>
	<span class='label'>Option Text</span><input type='text' id='optionText${t}' class='longField'>${makeTip("optionText")}<br>
	<span class='label'>Hover Text</span><input type='text' id='hoverText${t}' class='longField'>${makeTip("hoverText")}<br>
	<span class='label'>Next Statement</span><select id='gotoSection${t}' class='gotoNext'></select>${makeTip("nextStatement")}<br>
	<span class='label'>Execute At</span><input type='text' id='executeAt${t}' class='longField' value='execute at @p[scores={${$("#baseTag").val()}C=${commandSet},${$("#baseTag").val()}S=${1==e?"0..1":e}}] if entity @e[distance=..${$("#targetDistance").val()},limit=1,tag=${$("#baseTag").val()}] run'>${makeTip("executeAt")}<br>
	<input type='hidden' id='commandSet${t}' value='${commandSet}'>
	<div id='commands${t}' class='roundedDiv commands'><button id='addCommand${t}'>Add Command</button><br></div>
	</div>`),$("input, select").bind("change keyup",function(){generate()}),bindDelOption(t),bindAddCommand(t,commandSet),updateAllSectionOptions(),bindNextSection(t),generate()}function updateAllSectionOptions(){$(".gotoNext").each(function(){updateSectionOptions(this.id)})}function updateSectionOptions(e){var a=$("#"+e).val(),t=[],n=($(".npcSays").each(function(){t.push(this.id.match(numberPattern))}),t.sort(),[]);n.push('<option value="-1">Finish Talking</option>');for(var o=0;o<t.length;o++)n.push('<option value="',t[o],'">Statement ',t[o],"</option>");n.push('<option value="-2">New Statement</option>'),$("#"+e).html(n.join("")),null!=a&&0!==$("#"+e+" option[value='"+a+"']").length&&$("#"+e).val(a)}function bindNextSection(a){$("#gotoSection"+a).bind("click",function(e){-2==$("#gotoSection"+a).val()&&$("#gotoSection"+a).val(addNPCSays())})}function bindAddCommand(a,t){$("#addCommand"+a).bind("click",function(e){addCommand(a,t)})}function addCommand(e,a,t){var n;if(null==t)for(n=0;$("#command"+e+"_"+n).length;)n++;else n=t;t=e+"_"+n;$("#commands"+e).append(`<div id='commandDiv${t}' class='command roundedDiv'><span class='label'>Command ${n+1} </span><input type='text' id='command${t}' class='longField'><button id='delCommand${t}' class='redx'>X</button>${makeTip("command")} </div>`),$("input").bind("keyup",function(){generate()}),bindDelCommand(e+"_"+n),generate()}function bindDelCommand(a){$("#delCommand"+a).bind("click",function(e){$("#commandDiv"+a).remove(),generate()})}function bindDelOption(a){$("#delOption"+a).bind("click",function(e){$("#option"+a).remove(),generate()})}function generate(){$("#baseTag").val($("#baseTag").val().replace(/[^a-zA-Z0-9]/g,"")),15<$("#baseTag").val().length&&$("#baseTag").val($("#baseTag").val().substr(0,15)),$("#nameSpace").val($("#nameSpace").val().replace(/[^a-z0-9-_.]/g,"")),$("#datapackName").val($("#datapackName").val().replace(/[^a-zA-Z0-9-_. ]/g,"")),$("#description").val($("#description").val().replace(/"/g,"")),$("#targetDistance").val($("#targetDistance").val().replace(/[^0-9]/g,"")),$("#setupCommands").val(getSetUpMCFunction()),$("#cleanupCommands").val(getCleanUpMCFunction()),$("#mainCommands").val(getMainMCFunction());var e=$("#baseTag").val().toLowerCase(),a=$("#nameSpace").val(),t=`/function ${a}:main_`+e,n=`/function ${a}:setup_`+e,a=`/function ${a}:cleanup_`+e;$("#mainFunc").html(t),$("#setupFunc").html(n),$("#cleanupFunc").html(a)}function regenExecuteAt(){$(".npcSays").each(function(){var t=this.id.match(numberPattern);$("#npcSaysDiv"+t+" .option").each(function(){var e=t+"_"+this.id.match(numberPattern)[1],a=($("#optionText"+e).val($("#optionText"+e).val().replace(/"/g,"")),$("#commandSet"+e).val());$("#executeAt"+e).val(`execute at @p[scores={${$("#baseTag").val()}C=${a},${$("#baseTag").val()}S=${1==t?"0..1":t}}] if entity @e[distance=..${$("#targetDistance").val()},limit=1,tag=${$("#baseTag").val()}] run`)})}),generate()}function getMainMCFunction(){var i=$("#baseTag").val(),a=`distance=..${$("#targetDistance").val()},limit=1`,t=`scoreboard players enable @a ${i}S
scoreboard players enable @a ${i}C
scoreboard players enable @a ${i}P
`;for(fKey in functionSets={},$("#cmdSets").html(""),$(".npcSays").each(function(){var n=this.id.match(numberPattern),o=($("#npcSays"+n).val($("#npcSays"+n).val().replace(/"/g,"")),t+=`execute at @e[tag=${i}] as @e[tag=${i}] run tellraw @p[${a},scores={${i}S=${1==n?"0..1":n},${i}P=1}] {"text":"${$("#npcSays"+n).val()} ","color":"${$("#textColor").val()}"`,[]);if($("#npcSaysDiv"+n+" .option").each(function(){var a=n+"_"+this.id.match(numberPattern)[1],e=($("#optionText"+a).val($("#optionText"+a).val().replace(/"/g,"")),$("#optionText"+a).val()),t=$("#commandSet"+a).val(),e=`{"text":"${e}","color":"${$("#optionColor").val()}","clickEvent":{"action":"run_command","value":"/trigger ${i}C set ${t}"}`,e=($("#hoverText"+a).val().length&&($("#hoverText"+a).val($("#hoverText"+a).val().replace(/"/g,"")),e+=',"hoverEvent":{"action":"show_text","value":"'+$("#hoverText"+a).val()+'"}'),o.push(e+="}"),$("#executeAt"+a).val());functionSets[t]={e:e,commands:[]},$("#commands"+a+" .command").each(function(){var e=a+"_"+this.id.match(numberPattern)[2],e=$("#command"+e).val().trim();"/"==e.charAt(0)&&(e=e.substring(1)),functionSets[t].commands.push(e)}),functionSets[t].commands.push(`scoreboard players set @p[scores={${i}C=${t}}] ${$("#baseTag").val()}P 0`),functionSets[t].commands.push(`scoreboard players set @p[scores={${i}C=${t}}] ${$("#baseTag").val()}S `+$("#gotoSection"+a).val()),functionSets[t].commands.push(`scoreboard players set @p[scores={${i}C=${t}}] ${$("#baseTag").val()}C 0`)}),o.length){t+=',"extra":[';for(var e=0;e<o.length;e++)t+=o[e],e<o.length-1&&(t+=`,{"text":" or ","color":"${$("#textColor").val()}"},`);t+="]"}t+=`}
`}),functionSets){for(var e=`${functionSets[fKey].e} function ${$("#nameSpace").val()}:cmdgroup${fKey}_`+i.toLowerCase(),n=(t+=e+`
`,$("#cmdSets").append(e+`<br><textarea id='cmdgroup${fKey}' class='outputCommands'></textarea>`),""),o=0;o<functionSets[fKey].commands.length;o++)n+=functionSets[fKey].commands[o]+"\n";$("#cmdgroup"+fKey).val(n)}return $("#distanceReset").is(":checked")&&(t+=`execute at @e[tag=${i}] as @e[tag=${i}] run scoreboard players set @p[distance=${parseInt($("#targetDistance").val())+1}..,limit=1] ${i}S 0
`),t+=`execute at @e[tag=${i}] as @e[tag=${i}] run scoreboard players set @p[distance=${parseInt($("#targetDistance").val())+1}..,limit=1] ${i}C 0
`+`execute at @e[tag=${i}] as @e[tag=${i}] run scoreboard players set @p[distance=${parseInt($("#targetDistance").val())+1}..,limit=1] ${i}P 0
`+`execute at @e[tag=${i}] as @e[tag=${i}] run scoreboard players add @p[${a}] ${i}P 1
`}function getSetUpMCFunction(){return"scoreboard objectives add "+$("#baseTag").val()+"S trigger\nscoreboard objectives add "+$("#baseTag").val()+"C trigger\nscoreboard objectives add "+$("#baseTag").val()+"P trigger\ngamerule commandBlockOutput false\ngamerule sendCommandFeedback false"}function getCleanUpMCFunction(){return"scoreboard objectives remove "+$("#baseTag").val()+"S\nscoreboard objectives remove "+$("#baseTag").val()+"C\nscoreboard objectives remove "+$("#baseTag").val()+"P"}function makeTip(e){return"<a href=\"javascript:showTip('"+e+"')\" class='greenPlus' tabindex='-1'>?</a>"}function showTip(e){$("#dialogbox").load("tips/"+e+".txt",function(e,a){"success"==a?($("#dialogbox").css({top:mouse.y,left:mouse.x}),$("#dialogbox").show(),a=$("#dialogbox").has("a").length,$("#dialogbox").append("<a href=\"javascript:hideTip()\" class='greenPlus'>OK</a>"),a||($("#dialogbox").focus(),$("#dialogbox").blur(function(){$("#dialogbox").hide()}))):$("#dialogbox").hide()})}function hideTip(){$("#dialogbox").hide()}$(function(){$("#baseSettings").prepend(`<span class='label'>Base Tag</span><input type='text' id='baseTag' class='mediumField' value='MyNPC'><button onClick='regenExecuteAt()' class='redx' tabindex='-1'>R</button>${makeTip("baseTag")}<br>
	<span class='label'>Namespace</span><input type='text' id='nameSpace' class='mediumField' value='npcgenerator'>${makeTip("nameSpace")}<br>
	<span class='label'>Datapack Name</span><input type='text' id='datapackName' class='mediumField' value='MyDatapack'>${makeTip("datapackName")}<br>
	<span class='label'>Description</span><input type='text' id='description' class='mediumField' value='MCStacker Generated NPCs'>${makeTip("description")}<br>
	<span class='label'>Main Tick Tag</span><input type='checkbox' id='mainTick'>${makeTip("mainTick")}<br>
	<span class='label'>Distance Reset</span><input type='checkbox' id='distanceReset'>${makeTip("distanceReset")}<br>
	<span class='label'>Distance</span><input type='text' id='targetDistance' class='shortField' value='5'>${makeTip("targetDistance")}<br>
	<span class='label'>Text Color</span><select id='textColor'></select>${makeTip("textColor")}<br>
	<span class='label'>Option Color</span><select id='optionColor'></select>${makeTip("optionColor")}<br>`),$(document).mousemove(function(e){mouse.x=e.pageX,mouse.y=e.pageY});for(var e=["white","black","dark_blue","dark_green","dark_aqua","dark_red","dark_purple","gold","gray","dark_gray","blue","green","aqua","red","light_purple","yellow"],a=[],t=0;t<e.length;t++)a.push('<option value="',e[t],'">',e[t],"</option>");$("#jsonIn").hide(),$("#textColor").html(a.join("")),$("#optionColor").html(a.join("")),$("#optionColor").val("aqua"),$("input, select").bind("keyup change",function(){generate()}),addNPCSays(1),$("#addNPCButton").bind("click",function(){addNPCSays()}),$("#exportAsJSON").bind("click",function(){exportAsJSON()}),$("#importNPC").bind("click",function(){$("#jsonIn").show()}),$("#downloadButton").bind("click",function(){zipIt()})});